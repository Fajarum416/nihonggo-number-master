<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nihongo Number Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe;
        }
        .japanese-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .feedback {
            transition: opacity 0.3s ease-in-out;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .animate-popIn { animation: popIn 0.3s ease-out forwards; }
        .animate-shake { animation: shake 0.4s ease-in-out forwards; }
        
        #feedback {
            overflow-wrap: break-word;
            word-break: keep-all;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md mx-auto p-4">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Nihongo Number Master</h1>
            <p class="text-slate-600 mt-2 japanese-font text-base sm:text-lg">日本の数字の知識を試してみよう！</p>
        </header>

        <main class="bg-white p-5 sm:p-8 rounded-2xl shadow-xl">
            <!-- Tombol Ganti Mode -->
            <div class="flex border border-gray-200 rounded-lg p-1 mb-6">
                <button id="modeNumToHira" class="w-1/2 py-2 px-1 sm:px-2 rounded-md text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap">Angka → Hiragana</button>
                <button id="modeHiraToNum" class="w-1/2 py-2 px-1 sm:px-2 rounded-md text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap">Hiragana → Angka</button>
            </div>

            <!-- Pilihan Level Angka -->
            <div class="mb-6">
                <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">Pilih Level Angka:</label>
                <select id="difficultySelector" name="difficulty" class="w-full p-3 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-base">
                    <option value="100">Dasar (1 - 100)</option>
                    <option value="1000">Ratusan (1 - 1.000)</option>
                    <option value="10000">Ribuan (1 - 10.000)</option>
                    <option value="100000">Puluhan Ribu (1 - 100.000)</option>
                    <option value="1000000">Jutaan (1 - 1.000.000)</option>
                    <option value="10000000" selected>Puluhan Juta (1 - 10.000.000)</option>
                </select>
            </div>

            <!-- Area Kuis -->
            <div>
                <!-- Display Soal -->
                <div id="questionDisplay" class="bg-gray-100 w-full min-h-[6rem] p-4 flex items-center justify-center rounded-lg mb-4">
                    <p id="questionText" class="text-3xl sm:text-4xl font-bold text-slate-800 tracking-wider text-center break-words leading-tight"></p>
                </div>

                <!-- Input Jawaban -->
                <div id="answerSection">
                    <input type="text" id="answerInput" placeholder="Ketik jawaban Anda..." class="w-full p-4 border-2 border-gray-200 rounded-lg text-center text-base sm:text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
               
                <!-- Feedback -->
                <div id="feedback" class="feedback min-h-[1.5rem] mt-4 text-center font-semibold text-sm sm:text-base opacity-0"></div>

                <!-- Tombol Aksi -->
                <div class="flex items-center gap-3 mt-4">
                    <button id="checkButton" class="flex-1 bg-blue-500 text-white p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg hover:bg-blue-600 active:bg-blue-700 transition-transform transform active:scale-95 min-w-0">
                        Cek Jawaban
                    </button>
                    <button id="reloadButton" class="flex-shrink-0 bg-gray-200 text-gray-700 p-3 sm:p-4 rounded-lg hover:bg-gray-300 active:bg-gray-400 transition-colors" title="Soal Baru">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw h-5 w-5 sm:h-6 sm:w-6"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal untuk Penjelasan Kesalahan -->
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-4 sm:p-6 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg sm:text-xl font-bold text-slate-800">Analisis Jawaban</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="errorAnalysis" class="space-y-3 text-sm sm:text-base">
                <!-- Konten analisis akan dimasukkan oleh JavaScript -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Referensi Elemen DOM
    const modeNumToHiraBtn = document.getElementById('modeNumToHira');
    const modeHiraToNumBtn = document.getElementById('modeHiraToNum');
    const difficultySelector = document.getElementById('difficultySelector');
    const questionText = document.getElementById('questionText');
    const answerInput = document.getElementById('answerInput');
    const checkButton = document.getElementById('checkButton');
    const reloadButton = document.getElementById('reloadButton');
    const feedback = document.getElementById('feedback');
    const errorModal = document.getElementById('errorModal');
    const modalContent = document.getElementById('modalContent');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const errorAnalysis = document.getElementById('errorAnalysis');
    
    // State Aplikasi
    let currentMode = 'numToHira';
    let questions = { numToHira: { number: 0, hiragana: '' }, hiraToNum: { number: 0, hiragana: '' } };
    let correctAnswer = '';
    let wrongAttempts = 0;

    function numberToHiragana(num) {
        if (num === 0) return 'ゼロ';
        const convertChunk = (n, isManPrefix = false) => {
            if (n === 0) return '';
            const ones = ['', 'いち', 'に', 'さん', 'よん', 'ご', 'ろく', 'なな', 'はち', 'きゅう'];
            const tens = ['', 'じゅう', 'にじゅう', 'さんじゅう', 'よんじゅう', 'ごじゅう', 'ろくじゅう', 'ななじゅう', 'はちじゅう', 'きゅうじゅう'];
            let result = '';
            const thousands = Math.floor(n / 1000);
            if (thousands > 0) {
                if (thousands === 1) result += (isManPrefix ? 'いっせん' : 'せん');
                else if (thousands === 3) result += 'さんぜん';
                else if (thousands === 8) result += 'はっせん';
                else result += ones[thousands] + 'せん';
            }
            n %= 1000;
            const hundreds = Math.floor(n / 100);
            if (hundreds > 0) {
                if (hundreds === 1) result += 'ひゃく';
                else if (hundreds === 3) result += 'さんびゃく';
                else if (hundreds === 6) result += 'ろっぴゃく';
                else if (hundreds === 8) result += 'はっぴゃく';
                else result += ones[hundreds] + 'ひゃく';
            }
            n %= 100;
            if (n >= 10) result += tens[Math.floor(n / 10)];
            n %= 10;
            if (n > 0) result += ones[n];
            return result;
        };
        if (num < 10000) return convertChunk(num);
        const manPart = Math.floor(num / 10000);
        const remainderPart = num % 10000;
        const manStr = convertChunk(manPart, true) + 'まん';
        const remainderStr = convertChunk(remainderPart);
        return manStr + remainderStr;
    }

    function saveState() {
        localStorage.setItem('nihongoMasterState', JSON.stringify({
            currentMode: currentMode,
            questions: questions,
            difficulty: difficultySelector.value
        }));
    }

    function loadState() {
        const savedState = localStorage.getItem('nihongoMasterState');
        if (savedState) {
            const state = JSON.parse(savedState);
            if (state.currentMode && state.questions && state.difficulty) {
                currentMode = state.currentMode;
                questions = state.questions;
                difficultySelector.value = state.difficulty;
                return true;
            }
        }
        return false;
    }
    
    function updateQuestionDisplay() {
        const questionData = questions[currentMode];
        const questionDisplay = document.getElementById('questionDisplay'); 
        if (!questionData || questionData.number === 0) {
             generateQuestionForCurrentMode();
             return;
        }
        questionDisplay.classList.remove('animate-fadeIn');
        void questionDisplay.offsetWidth; 
        questionDisplay.classList.add('animate-fadeIn');
        if (currentMode === 'numToHira') {
            questionText.textContent = questionData.number.toLocaleString('en-US');
            questionText.classList.remove('japanese-font');
            correctAnswer = questionData.hiragana;
        } else {
            questionText.textContent = questionData.hiragana;
            questionText.classList.add('japanese-font');
            correctAnswer = questionData.number.toString();
        }
        wrongAttempts = 0;
        answerInput.disabled = false;
        checkButton.disabled = false;
    }

    function generateQuestionForCurrentMode() {
        answerInput.value = '';
        hideFeedback();
        const maxNumber = parseInt(difficultySelector.value);
        const newNumber = Math.floor(Math.random() * maxNumber) + 1;
        questions[currentMode] = { number: newNumber, hiragana: numberToHiragana(newNumber) };
        updateQuestionDisplay();
        saveState();
    }
    
    function switchMode(newMode) {
        currentMode = newMode;
        answerInput.value = ''; 
        hideFeedback();
        if (newMode === 'numToHira') {
            modeNumToHiraBtn.classList.add('bg-blue-500', 'text-white');
            modeNumToHiraBtn.classList.remove('bg-gray-100', 'text-gray-700');
            modeHiraToNumBtn.classList.remove('bg-blue-500', 'text-white');
            modeHiraToNumBtn.classList.add('bg-gray-100', 'text-gray-700');
            answerInput.type = 'text';
            answerInput.placeholder = 'Ketik jawaban Hiragana...';
        } else {
            modeHiraToNumBtn.classList.add('bg-blue-500', 'text-white');
            modeHiraToNumBtn.classList.remove('bg-gray-100', 'text-gray-700');
            modeNumToHiraBtn.classList.remove('bg-blue-500', 'text-white');
            modeNumToHiraBtn.classList.add('bg-gray-100', 'text-gray-700');
            answerInput.type = 'number';
            answerInput.placeholder = 'Masukkan angka...';
        }
        updateQuestionDisplay();
        saveState();
    }
    
    function showFeedback(message, isCorrect) {
        feedback.classList.remove('animate-popIn', 'animate-shake');
        void feedback.offsetWidth;
        feedback.textContent = message;
        feedback.style.color = isCorrect ? '#16a34a' : '#dc2626';
        feedback.classList.remove('opacity-0');
        feedback.classList.add(isCorrect ? 'animate-popIn' : 'animate-shake');
    }
    
    function hideFeedback() {
        feedback.classList.add('opacity-0');
    }

    function analyzeError(userAnswer, correctAnswer, questionNumber) {
        let diffIndex = -1;
        for (let i = 0; i < correctAnswer.length; i++) {
            if (i >= userAnswer.length || userAnswer[i] !== correctAnswer[i]) {
                diffIndex = i;
                break;
            }
        }
        if (diffIndex === -1 && userAnswer.length !== correctAnswer.length) {
            diffIndex = Math.min(userAnswer.length, correctAnswer.length);
        }

        let userHtml;
        if (diffIndex !== -1) {
            const correctPart = userAnswer.substring(0, diffIndex);
            const incorrectPart = userAnswer.substring(diffIndex);
            userHtml = `<span class="text-green-600">${correctPart}</span><span class="bg-red-200 text-red-800 font-bold px-1 rounded">${incorrectPart}</span>`;
        } else {
            userHtml = `<span class="text-green-600">${userAnswer}</span>`;
        }

        let explanation = '';
        const userChar = userAnswer[diffIndex];
        const correctChar = correctAnswer[diffIndex];
        const prevCorrectChars = correctAnswer.substring(diffIndex - 3, diffIndex);

        const commonMistakes = {
            'ひ': { 'び': 'Dakuten (゛)', 'ぴ': 'Handakuten (゜)' }, 'は': { 'ば': 'Dakuten (゛)', 'ぱ': 'Handakuten (゜)' },
            'ふ': { 'ぶ': 'Dakuten (゛)', 'ぷ': 'Handakuten (゜)' }, 'へ': { 'べ': 'Dakuten (゛)', 'ぺ': 'Handakuten (゜)' },
            'ほ': { 'ぼ': 'Dakuten (゛)', 'ぽ': 'Handakuten (゜)' }, 'さ': { 'ざ': 'Dakuten (゛)' }, 'し': { 'じ': 'Dakuten (゛)' },
            'す': { 'ず': 'Dakuten (゛)' }, 'せ': { 'ぜ': 'Dakuten (゛)' }, 'そ': { 'ぞ': 'Dakuten (゛)' },
            'た': { 'だ': 'Dakuten (゛)' }, 'ち': { 'ぢ': 'Dakuten (゛)' }, 'つ': { 'づ': 'Dakuten (゛)' }, 'て': { 'で': 'Dakuten (゛)' },
            'と': { 'ど': 'Dakuten (゛)' }, 'き': { 'ぎ': 'Dakuten (゛)' }, 'く': { 'ぐ': 'Dakuten (゛)' },
            'け': { 'げ': 'Dakuten (゛)' }, 'こ': { 'ご': 'Dakuten (゛)' },
        };

        if (!userChar) {
            explanation = `Jawaban Anda belum lengkap. Setelah <span class="font-bold text-slate-700">${userAnswer}</span>, seharusnya dilanjutkan dengan <span class="font-bold text-slate-700">${correctAnswer.substring(diffIndex)}</span>.`;
        } else if (correctChar === 'っ' && userChar !== 'っ') {
            explanation = `Perhatikan aturan <span class="font-bold text-red-600">Sokuon (っ)</span> atau perubahan suara. Setelah <span class="font-bold">${prevCorrectChars}</span>, seharusnya ada konsonan ganda yang ditandai dengan 'tsu' kecil.`;
        } else if (commonMistakes[userChar] && commonMistakes[userChar][correctChar]) {
            const mistakeType = commonMistakes[userChar][correctChar];
            explanation = `Terjadi kesalahan pada perubahan suara <span class="font-bold text-red-600">${mistakeType}</span>. Seharusnya ditulis <span class="font-bold text-green-700">'${correctChar}'</span>, bukan <span class="font-bold text-red-700">'${userChar}'</span>.`;
        } else if (userAnswer.length > correctAnswer.length && diffIndex >= correctAnswer.length) {
            explanation = `Jawaban Anda terlalu panjang. Bagian <span class="font-bold bg-red-200 px-1 rounded">${userAnswer.substring(correctAnswer.length)}</span> seharusnya tidak ada.`;
        } else {
            const context = userAnswer.substring(0, diffIndex);
            const shouldBe = correctAnswer.substring(diffIndex);
            const incorrectPart = userAnswer.substring(diffIndex);
            
            explanation = `Setelah <span class="font-bold text-slate-700">${context}</span>, seharusnya dilanjutkan dengan <span class="font-bold text-green-700">${shouldBe}</span>. Jawaban Anda salah pada bagian <span class="font-bold text-red-700">${incorrectPart}</span>.`;
        }

        return `
            <div class="border-b pb-3 mb-3">
                <p class="text-xs sm:text-sm text-gray-600">Soal Angka:</p>
                <p class="text-xl sm:text-2xl font-bold text-slate-800">${questionNumber.toLocaleString('en-US')}</p>
            </div>
            <p class="font-semibold">Jawaban Anda:</p>
            <div class="p-3 rounded-lg bg-gray-100 text-gray-800 japanese-font text-base sm:text-lg break-words">${userHtml}</div>
            <p class="mt-3 font-semibold">Jawaban Benar:</p>
            <div class="p-3 rounded-lg bg-green-100 border border-green-200 text-green-800 japanese-font text-base sm:text-lg break-words">${correctAnswer}</div>
            <div class="mt-4 p-3 rounded-lg bg-yellow-100 border border-yellow-200 text-yellow-900">
                <h4 class="font-bold mb-1">Penjelasan Kesalahan:</h4>
                <p>${explanation}</p>
            </div>
        `;
    }

    function analyzeNumberError(userAnswer, correctAnswer, questionHiragana) {
        const userStr = userAnswer.toString();
        const correctStr = correctAnswer.toString();

        let diffIndex = -1;
        for (let i = 0; i < correctStr.length; i++) {
            if (i >= userStr.length || userStr[i] !== correctStr[i]) {
                diffIndex = i;
                break;
            }
        }
        if (diffIndex === -1 && userStr.length !== correctStr.length) {
            diffIndex = Math.min(userStr.length, correctStr.length);
        }

        let userHtml;
        if (diffIndex !== -1) {
            const correctPart = userStr.substring(0, diffIndex);
            const incorrectPart = userStr.substring(diffIndex);
            userHtml = `<span class="text-green-600">${correctPart}</span><span class="bg-red-200 text-red-800 font-bold px-1 rounded">${incorrectPart}</span>`;
        } else {
            userHtml = `<span class="text-green-600">${userStr}</span>`;
        }

        let explanation = '';
        if (diffIndex !== -1) {
            const context = userStr.substring(0, diffIndex);
            const shouldBe = correctStr.substring(diffIndex);
            const incorrectPart = userStr.substring(diffIndex);

            if (context === '') {
                 explanation = `Jawaban Anda salah dari digit pertama. Seharusnya dimulai dengan <span class="font-bold text-green-700">${shouldBe}</span>, bukan <span class="font-bold text-red-700">${incorrectPart}</span>.`;
            } else {
                 explanation = `Setelah digit <span class="font-bold text-slate-700">${context}</span>, seharusnya dilanjutkan dengan <span class="font-bold text-green-700">${shouldBe}</span>. Jawaban Anda salah pada bagian <span class="font-bold text-red-700">${incorrectPart}</span>.`;
            }
        } else {
            explanation = "Terjadi kesalahan yang tidak terduga. Mohon periksa kembali jawaban Anda.";
        }
        
        return `
            <div class="border-b pb-3 mb-3">
                <p class="text-xs sm:text-sm text-gray-600">Soal Hiragana:</p>
                <p class="text-xl sm:text-2xl font-bold text-slate-800 japanese-font break-words">${questionHiragana}</p>
            </div>
            <p class="font-semibold">Jawaban Angka Anda:</p>
            <div class="p-3 rounded-lg bg-gray-100 text-gray-800 text-base sm:text-lg font-mono tracking-widest">${userHtml}</div>
            <p class="mt-3 font-semibold">Jawaban Angka Benar:</p>
            <div class="p-3 rounded-lg bg-green-100 border border-green-200 text-green-800 text-base sm:text-lg font-mono tracking-widest">${correctAnswer}</div>
            <div class="mt-4 p-3 rounded-lg bg-yellow-100 border border-yellow-200 text-yellow-900">
                <h4 class="font-bold mb-1">Penjelasan Kesalahan:</h4>
                <p>${explanation}</p>
            </div>
        `;
    }

    function showModal() {
        errorModal.classList.remove('hidden');
        setTimeout(() => {
            errorModal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95', 'opacity-0');
        }, 10);
    }

    function hideModal() {
        errorModal.classList.add('opacity-0');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            errorModal.classList.add('hidden');
        }, 300);
    }

    function checkAnswer() {
        const userAnswer = answerInput.value.trim().toLowerCase();
        if (!userAnswer) return;

        if (userAnswer === correctAnswer) {
            showFeedback('Benar! Bagus sekali!', true);
            answerInput.disabled = true;
            checkButton.disabled = true;
            setTimeout(generateQuestionForCurrentMode, 1500);
        } else {
            wrongAttempts++;

            if (wrongAttempts >= 3) {
                showFeedback(`Jawaban benar: ${correctAnswer}`, false);
                answerInput.disabled = true;
                checkButton.disabled = true;

                if (currentMode === 'numToHira') {
                    errorAnalysis.innerHTML = analyzeError(userAnswer, correctAnswer, questions[currentMode].number);
                    showModal();
                } else if (currentMode === 'hiraToNum') {
                    errorAnalysis.innerHTML = analyzeNumberError(userAnswer, correctAnswer, questions[currentMode].hiragana);
                    showModal();
                }
            } else {
                showFeedback('Salah, coba lagi!', false);
                answerInput.focus();
            }
        }
    }

    function initializeBothQuestions() {
        const maxNumber = parseInt(difficultySelector.value);
        let num1 = Math.floor(Math.random() * maxNumber) + 1;
        questions.numToHira = { number: num1, hiragana: numberToHiragana(num1) };
        let num2;
        do { num2 = Math.floor(Math.random() * maxNumber) + 1; } while (num1 === num2);
        questions.hiraToNum = { number: num2, hiragana: numberToHiragana(num2) };
        saveState();
    }

    // Event Listeners
    modeNumToHiraBtn.addEventListener('click', () => switchMode('numToHira'));
    modeHiraToNumBtn.addEventListener('click', () => switchMode('hiraToNum'));
    difficultySelector.addEventListener('change', () => {
        initializeBothQuestions();
        updateQuestionDisplay();
    });
    reloadButton.addEventListener('click', generateQuestionForCurrentMode);
    checkButton.addEventListener('click', checkAnswer);
    answerInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            checkButton.click();
        }
    });
    closeModalBtn.addEventListener('click', hideModal);
    errorModal.addEventListener('click', (e) => {
        if (e.target === errorModal) hideModal();
    });

    // Inisialisasi Aplikasi
    if (!loadState()) {
        initializeBothQuestions();
    }
    switchMode(currentMode); 
});
</script>
</body>
</html>

